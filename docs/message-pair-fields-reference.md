# MessagePair Fields Reference

**Purpose:** Complete reference for all MessagePair fields to ensure nothing is missed when creating/updating pairs.

**Source:** `/src/core/models/messagePair.js`

---

## Core Identity

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | ✓ | UUID (generated by store.addMessagePair) |
| `createdAt` | number | ✓ | Unix timestamp (ms) - NEVER changes, even on re-ask |
| `topicId` | string | ✓ | Topic ID |
| `model` | string | ✓ | Model used for response (e.g., 'gemini-2.0-flash-exp') |

---

## User Input

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `userText` | string | ✓ | User message content |
| `userChars` | number | ✓ | Ground truth char count of userText |
| `attachments` | string[] | ✓ | Image IDs attached to user message (empty array if none) |

---

## Assistant Response (Current)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `assistantText` | string | ✓ | Assistant response content (always preserved) |
| `assistantChars` | number | ✓ | Ground truth char count of assistantText |
| `lifecycleState` | 'idle'\|'sending'\|'error'\|'complete' | ✓ | Current state |
| `errorMessage` | string\|undefined | - | Error message if state='error' |

---

## Token Metrics (NEW STRUCTURE)

**All token-related data grouped in `tokenMetrics` object:**

```javascript
{
  tokenMetrics: {
    // User (always estimated)
    userChars: 245,
    userEstimatedTokens: 61,
    
    // Assistant (estimated + reported)
    assistantChars: 450,
    assistantEstimatedTokens: 112,
    assistantReportedTokens: 115,  // From provider (authoritative)
    
    // Previous assistant (for re-ask)
    previousAssistantChars: 420,
    previousAssistantEstimatedTokens: 105,
    previousAssistantReportedTokens: 108,
    
    // Images
    imageCount: 2,
    imageTokensByProvider: {
      openai: 2550,
      anthropic: 4800,
      gemini: 258,
      grok: 2550,
    }
  }
}
```

### Field Descriptions

| Field | Type | Source | Description |
|-------|------|--------|-------------|
| `userChars` | number | `userText.length` | Ground truth character count (never changes) |
| `userEstimatedTokens` | number | `estimateTextTokens(userText, provider)` | Estimated tokens (cached for performance) |
| `assistantChars` | number | `assistantText.length` | Ground truth character count |
| `assistantEstimatedTokens` | number | `estimateTextTokens(assistantText, provider)` | Estimated tokens (fallback if no reported) |
| `assistantReportedTokens` | number | `response.usage.completionTokens` | Provider-reported tokens (authoritative, highest priority) |
| `previousAssistantChars` | number | Moved from old `assistantChars` | Previous response char count (re-ask) |
| `previousAssistantEstimatedTokens` | number | Moved from old `assistantEstimatedTokens` | Previous estimated tokens (re-ask) |
| `previousAssistantReportedTokens` | number | Moved from old `assistantReportedTokens` | Previous reported tokens (re-ask) |
| `imageCount` | number | `attachments.length` | Number of attached images |
| `imageTokensByProvider` | Object | Per-image formula | Token costs by provider (OpenAI, Anthropic, Gemini, Grok) |

### Token Estimation Priority (for budgeting)

**When calculating context budget:**

1. **Assistant tokens:**
   - First: `tokenMetrics.assistantReportedTokens` (most accurate)
   - Fallback: `tokenMetrics.assistantEstimatedTokens`

2. **User tokens:**
   - Always: `tokenMetrics.userEstimatedTokens` (no provider data pre-send)

3. **Image tokens:**
   - Use: `tokenMetrics.imageTokensByProvider[currentProvider]`

### Why This Structure?

**Estimated Tokens:**
- Expensive to calculate (especially with real tokenizers)
- Cache to avoid re-calculating for every budget check
- Recalculate when:
  - Tokenizer implementation changes
  - Provider changes (if provider-specific)

**Reported Tokens:**
- From provider response (authoritative)
- Only available for assistant (post-response)
- Highest priority for budget calculations

**Chars:**
- Lightweight ground truth
- Backward compatibility
- Useful for heuristics/displays

---

## Token Metrics (LEGACY - DEPRECATED)

**Old structure - avoid in new code:**

| Field | Status | Replacement |
|-------|--------|-------------|
| `userChars` | ⚠️ Moved | `tokenMetrics.userChars` |
| `assistantChars` | ⚠️ Moved | `tokenMetrics.assistantChars` |
| `textTokens` | ❌ Deprecated | Calculate from `tokenMetrics.userEstimatedTokens + assistantEstimatedTokens` |
| `attachmentTokens` | ❌ Deprecated | Use `tokenMetrics.imageTokensByProvider[provider]` |
| `assistantProviderTokens` | ⚠️ Moved | `tokenMetrics.assistantReportedTokens` |
| `tokenLength` | ❌ Deprecated | Do not use |

**Migration notes:**
- Old fields kept for backward compatibility
- New code should use `tokenMetrics` structure
- Will be removed in future major version

---

## Response Metadata (Current Response)

| Field | Type | Required | Source | Description |
|-------|------|----------|--------|-------------|
| `responseMs` | number | - | **Calculated:** Date.now() - requestStartTime | Provider response time in milliseconds |
| `citations` | string[] | - | **From provider:** response.citations | Source URLs from web search (xAI, Gemini) |
| `citationsMeta` | {[url:string]: string} | - | **From provider:** response.citationsMeta | URL → display title/label mapping |
| `providerMeta` | Object | - | **From provider:** response.providerMeta | Provider-specific metadata (reserved) |

---

## Content Processing (Code/Equations)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `processedContent` | string | - | Content with code/equation placeholders (e.g., `[:python-1]`) |
| `codeBlocks` | CodeBlock[] | - | Extracted code blocks (only if detected) |
| `equationBlocks` | EquationBlock[] | - | Extracted equation blocks (only if detected) |

**CodeBlock structure:**
```javascript
{
  index: number,        // 1-based
  language: string,     // e.g., 'python', 'javascript'
  code: string,         // extracted content
  lineCount: number,
  startPos: number,
  endPos: number
}
```

**EquationBlock structure:**
```javascript
{
  index: number,        // 1-based
  raw: string,          // LaTeX expression
  unicode: string,      // Unicode fallback
  mode: 'display'|'inline'
}
```

---

## Re-ask / Response Variants (Optional)

**Only present when user re-asks for "second opinion":**

### Previous Response Data

| Field | Type | Source | Description |
|-------|------|--------|-------------|
| `previousAssistantText` | string | **Moved from:** old assistantText | Old assistant response (moved here on replacement) |
| `previousModel` | string | **Moved from:** old model | Model that generated previous response |
| `previousAssistantChars` | number | **Moved from:** old assistantChars | Char count of previous response |
| `previousAssistantProviderTokens` | number | **Moved from:** old assistantProviderTokens | Provider tokens for previous response |

### Previous Response Metadata

| Field | Type | Source | Description |
|-------|------|--------|-------------|
| `previousCitations` | string[] | **Moved from:** old citations | Source URLs from previous response |
| `previousCitationsMeta` | {[url:string]: string} | **Moved from:** old citationsMeta | URL → title mapping from previous |
| `previousProcessedContent` | string | **Moved from:** old processedContent | Previous content with placeholders |
| `previousCodeBlocks` | CodeBlock[] | **Moved from:** old codeBlocks | Previous extracted code blocks |
| `previousEquationBlocks` | EquationBlock[] | **Moved from:** old equationBlocks | Previous extracted equations |

### Replacement Metadata

| Field | Type | Source | Description |
|-------|------|--------|-------------|
| `replacedAt` | number | **New:** Date.now() | Timestamp (ms) when replacement occurred |
| `replacedBy` | string | **New:** model name | Model/actor that created replacement |

**Important:** `createdAt` stays original even on re-ask (honest chronology)

---

## User Flags

| Field | Type | Description |
|-------|------|-------------|
| `star` | 0\|1\|2\|3 | User rating (0 = no star) |
| `colorFlag` | 'b'\|'g' | Blue flagged or grey unflagged |

---

## Image Budgeting (Denormalized)

| Field | Type | Description |
|-------|------|-------------|
| `imageBudgets` | ImageBudget[] | Denormalized image metadata for fast token estimation |

**ImageBudget structure:**
```javascript
{
  id: string,           // Image ID
  w: number,            // Width in pixels
  h: number,            // Height in pixels
  tokenCost: {          // Provider-specific costs
    openai: number,
    anthropic: number,
    gemini: number,
    grok: number
  }
}
```

---

## Implementation Notes

### Creating New Pair (Normal Send)

**Required fields:**
1. Core: id (auto), createdAt (auto), topicId, model
2. Content: userText, assistantText
3. Chars: userChars, assistantChars
4. Tokens: textTokens, assistantProviderTokens
5. State: lifecycleState='complete'
6. Images: attachments, attachmentTokens (if has images)

**Optional fields (if available):**
- responseMs (timing)
- citations, citationsMeta (web search results)
- processedContent, codeBlocks, equationBlocks (content processing)
- imageBudgets (denormalized image metadata)

### Updating Pair (Re-ask)

**Move to "previous" slots:**
- assistantText → previousAssistantText
- model → previousModel
- assistantChars → previousAssistantChars
- assistantProviderTokens → previousAssistantProviderTokens
- citations → previousCitations (if exists)
- citationsMeta → previousCitationsMeta (if exists)
- processedContent → previousProcessedContent (if exists)
- codeBlocks → previousCodeBlocks (if exists)
- equationBlocks → previousEquationBlocks (if exists)

**Set new values:**
- assistantText (new response)
- model (new model)
- assistantChars (new count)
- assistantProviderTokens (new tokens)
- textTokens (recalculate: userChars + assistantChars)
- replacedAt (Date.now())
- replacedBy (model name)
- lifecycleState='complete'
- errorMessage=undefined (clear any error)
- citations (from new response, if exists)
- citationsMeta (from new response, if exists)

**Preserve unchanged:**
- createdAt (NEVER changes)
- userText, userChars
- attachments, attachmentTokens, imageBudgets
- responseMs (keep original timing)

**Recalculate from new response:**
- processedContent, codeBlocks, equationBlocks (extract from new assistantText)

---

## Field Priority for Token Estimation

When estimating tokens (for context calculations):

1. **assistantProviderTokens** - highest priority (actual from provider)
2. **textTokens** - fallback if provider tokens missing
3. **Calculate from chars** - last resort using charsPerToken heuristic

For images:
1. **imageBudgets** - preferred (has per-provider costs)
2. **attachmentTokens** - fallback (legacy single number)

---

## Common Mistakes to Avoid

❌ **Don't** change `createdAt` on re-ask  
✅ **Do** keep original timestamp, use `replacedAt` for replacement time

❌ **Don't** forget to recalculate `textTokens` on re-ask  
✅ **Do** recalculate: userChars + new assistantChars → tokens

❌ **Don't** lose previous response data  
✅ **Do** move ALL assistant-specific fields to `previous*` versions (text, metadata, content processing)

❌ **Don't** forget to clear `errorMessage` on successful re-ask  
✅ **Do** set `errorMessage=undefined` and `lifecycleState='complete'`

❌ **Don't** forget to extract code/equations from new response  
✅ **Do** re-run extraction and update `processedContent`, `codeBlocks`, `equationBlocks`

❌ **Don't** forget to preserve previous metadata (citations, code blocks, etc.)  
✅ **Do** move `citations`, `codeBlocks`, etc. to `previousCitations`, `previousCodeBlocks`, etc.

---

## See Also

- `/src/core/models/messagePair.js` - Source of truth for typedef
- `/src/shared/types.js` - JSDoc type definitions
- `/docs/response_variants_spec.md` - Re-ask behavior specification
- `/docs/image_messages_spec.md` - Image attachment details
